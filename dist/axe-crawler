#!/usr/bin/env node
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("validator"),require("axios"),require("cheerio"),require("fs"),require("minimist"),require("utility-logger"),require("knex"),require("objection"),require("selenium-webdriver"),require("selenium-webdriver/chrome"),require("axe-webdriverjs"),require("marked"),require("escape-html")):"function"==typeof define&&define.amd?define(["validator","axios","cheerio","fs","minimist","utility-logger","knex","objection","selenium-webdriver","selenium-webdriver/chrome","axe-webdriverjs","marked","escape-html"],t):t(e.validator,e.axios,e.cheerio,e.fs,e.minimist,e.Logger,e.Knex,e.objection,e.webDriver,e.chromeDriver,e.axeBuilder,e.marked,e.escape)}(this,function(e,t,r,i,n,s,o,a,l,c,u,d,h){"use strict";function p(t){const{domain:r,ignore:i,whitelist:n}=t,s=new RegExp(i||"^$"),o=new RegExp(n||".*");return t=>e.isURL(t)&&(c=t,!/(uploads\/\d{4}\/\d{2}\/)/.test(c)&&!/attachment_id/.test(c)&&!/\.(exe|wmv|avi|flv|mov|mkv|mp..?|swf|ra.?|rm|as.|m4[av]|smi.?|doc|docx|ppt|pptx|pps|ppsx|jpg|png|gif|pdf)$/.test(c))&&(l=t,!new RegExp("mailto:\\w+").test(l))&&(a=r,e=>new RegExp(`^https?://([\\w&&[^\\?=\\&\\.]]*\\.?)*?${a}/?.*$`).test(e)||/^\/\w+/.test(e))(t)&&o.test(t)&&(!!n||!s.test(t));var a,l,c}t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,i=i&&i.hasOwnProperty("default")?i.default:i,n=n&&n.hasOwnProperty("default")?n.default:n,s=s&&s.hasOwnProperty("default")?s.default:s,o=o&&o.hasOwnProperty("default")?o.default:o,l=l&&l.hasOwnProperty("default")?l.default:l,c=c&&c.hasOwnProperty("default")?c.default:c,u=u&&u.hasOwnProperty("default")?u.default:u,d=d&&d.hasOwnProperty("default")?d.default:d,h=h&&h.hasOwnProperty("default")?h.default:h;!function(){function e(e){this.value=e}function t(t){var r,i;function n(r,i){try{var o=t[r](i),a=o.value;a instanceof e?Promise.resolve(a.value).then(function(e){n("next",e)},function(e){n("throw",e)}):s(o.done?"return":"normal",o.value)}catch(e){s("throw",e)}}function s(e,t){switch(e){case"return":r.resolve({value:t,done:!0});break;case"throw":r.reject(t);break;default:r.resolve({value:t,done:!1})}(r=r.next)?n(r.key,r.arg):i=null}this._invoke=function(e,t){return new Promise(function(s,o){var a={key:e,arg:t,resolve:s,reject:o,next:null};i?i=i.next=a:(r=i=a,n(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}();var f=function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function i(n,s){try{var o=t[n](s),a=o.value}catch(e){return void r(e)}if(!o.done)return Promise.resolve(a).then(function(e){i("next",e)},function(e){i("throw",e)});e(a)}("next")})}};let m=(y=f(function*(e){const{logger:r}=this[g],i=[];return yield[...e].reduce(function(e,n,s){return e.then(function(){return r.debug(`Fetching #${s+1}: ${n}`),t.get(n).catch(function(e){return e}).then(function(e){return i.push(e)})})},Promise.resolve([])),i}),function(e){return y.apply(this,arguments)});var y;const g=Symbol("Options"),b=Symbol("Set of unique links to be tested"),v=Symbol("Add all links on a page to UNIQUE_LINKS"),w=Symbol("Filter out broken, invalid, media, etc. links"),$=Symbol("Perform axios.get on each url in an array and return array of completed responses"),S=Symbol("Build a set of links scraped from an array of axios reponses");function x(e,t){if(e instanceof Set){for(const r of e)t.add(r);return t}return t}class P extends a.Model{static createTable(e){return f(function*(){return yield e.schema.dropTableIfExists("violations"),e.schema.createTableIfNotExists("violations",function(e){e.increments("id").primary(),e.string("url"),e.string("viewPort"),e.string("report")})})()}static get tableName(){return"violations"}}class k extends a.Model{static createTable(e){return f(function*(){return yield e.schema.dropTableIfExists("passes"),e.schema.createTableIfNotExists("passes",function(e){e.increments("id").primary(),e.string("url"),e.string("viewPort"),e.string("report")})})()}static get tableName(){return"passes"}}class E extends a.Model{static createTable(e){return f(function*(){return yield e.schema.dropTableIfExists("axe_results"),e.schema.createTableIfNotExists("axe_results",function(e){e.increments("id").primary(),e.string("url").unique()})})()}static get tableName(){return"axe_results"}static get relationMappings(){return{violations:{relation:a.Model.HasManyRelation,modelClass:P,join:{from:"violations.url",to:"axe_results.url"}},passes:{relation:a.Model.HasManyRelation,modelClass:k,join:{from:"passes.url",to:"axe_results.url"}}}}}var O=(()=>{var e=f(function*(e){const t=new s({level:"debug"});var r;var i;E.knex(e),P.knex(e),k.knex(e),yield E.createTable(e),yield P.createTable(e),yield k.createTable(e);return{create:{axe_result:(r=f(function*({url:e,viewPort:r,violations:i,passes:n}){return Promise.all([E.query().insert({url:e}).catch(function(e){if(!e.message.match("SQLITE_CONSTRAINT: UNIQUE"))throw e}),P.query().insert({url:e,viewPort:r,report:i}),k.query().insert({url:e,viewPort:r,report:n})]).catch(function(e){t.error(e)})}),function(e){return r.apply(this,arguments)})},read:{axe_result:function({url:e,viewPort:r}){E.query().then(function(e){return t.debug(`Result received: ${JSON.stringify(e)}`)}).catch(function(e){return t.error(`Error reading from DB: ${e}`)}),P.query().then(function(e){return t.debug(`Result received: ${JSON.stringify(e)}`)}).catch(function(e){return t.error(`Error reading from DB: ${e}`)})},tested_pages:function(){return E.query()},violations_summary:function({url:e}){return P.query().where("url",e)},passes_summary:function({url:e}){return k.query().where("url",e)},summary:(i=f(function*({url:e}){return{violations:yield P.query().where("url",e),passes:yield k.query().where("url",e)}}),function(e){return i.apply(this,arguments)})},update:{},delete:{}}});return function(t){return e.apply(this,arguments)}})();const N=Symbol("Database type"),T=Symbol("Database CREATE"),q=Symbol("Database READs"),j=Symbol("Database UPDATE"),_=Symbol("Database DELETE");class R{constructor({type:e="memory"}){this[N]=e}initialize(){var e=this;return f(function*(){switch(e[N]){case"memory":e._db=o({client:"sqlite3",connection:{filename:":memory:"},useNullAsDefault:!0});break;case"file":e._db=o({client:"sqlite3",connection:{filename:"axe-crawler.db"},useNullAsDefault:!0});break;default:throw new TypeError("Invalid SQLite database type")}const t=yield O(e._db);e[T]=t.create,e[q]=t.read,e[j]=t.update,e[_]=t.delete})()}close(){this._db.close()}create(e,t){return this[T][e](t)}read(e,t){return this[q][e](t)}update(e,t){return this[j][e](t)}delete(e,t){return this[_][e](t)}}const D="./.axe-crawler.json",F=require("../package.json").version,J={depth:5,check:void 0,output:"reports",ignore:"^$",whitelist:".*",random:1,viewPorts:[{name:"mobile",width:360,height:640},{name:"tablet_vertical",width:768,height:1024},{name:"tablet_horizontal",width:1024,height:768},{name:"desktop",width:1440,height:900}],verbose:"error",useFileOver:50},I=Symbol("Command line arguments"),A=Symbol("JSON specified configuration"),C=Symbol("Default configuration");let M=(K=f(function*(e){var t=this;const r=this[X];var i;r(d("## Summary of Overall Test Results")),r('<table class="summary-table"><thead><tr><th scope="col">URL</th><th scope="col">Failing Tests</th><th scope="col">Passing Tests</th></tr></thead><tbody>'),yield Promise.all(e.map((i=f(function*({url:e}){const i=yield t[z].db.read("summary",{url:e});yield r(`<tr><th scope="row">${e}</th>`),yield r(`<td>${te.call(t,i,"violations")}</td>`),yield r(`<td>${te.call(t,i,"passes")}</td></tr>`)}),function(e){return i.apply(this,arguments)}))),r("</tbody></table>")}),function(e){return K.apply(this,arguments)});var K;let L=(U=f(function*(e){var t=this;const r=this[X];var i,n;r(d(`## Detailed List of Failing Tests: ${this[B].violations} failing tests`)),yield Promise.all(e.map((i=f(function*({url:e}){const i=yield t[z].db.read("violations_summary",{url:e});re(i)>0&&(r(d(`### ${h(e)}`)),yield Promise.all(i.map(function(e){return r(ne(e,"failed tests"))})))}),function(e){return i.apply(this,arguments)}))),r(d(`## Detailed List of Passing Tests: ${this[B].passes} passing tests`)),yield Promise.all(e.map((n=f(function*({url:e}){const i=yield t[z].db.read("passes_summary",{url:e});re(i)>0&&(r(d(`### ${h(e)}`)),yield Promise.all(i.map(function(e){return r(ne(e,"passing tests"))})))}),function(e){return n.apply(this,arguments)})))}),function(e){return U.apply(this,arguments)});var U;const z=Symbol("Options"),Q=Symbol("Filename"),B=Symbol("Total count of passing and failing tests"),H='<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.8.0/github-markdown.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous">',W=i.readFileSync(`${__dirname}/index.css`),G=Symbol("Prepare HTML File"),X=Symbol("Append an html string to the report file"),Z=Symbol("Write html summary table"),V=Symbol("Write complete test results to html"),Y=Symbol("Append closing tags and close html file");class ee{constructor(e){this[z]=e,this[B]={passes:0,violations:0},this[G]=function(){const e=this[X],t=`aXe Accessibility Engine Report for ${this[z].domain}  \n${(new Date).toString()}`;e(`<!doctype html> <html lang="en"><head><title>${t}</title><meta name="viewport" content="width=device-width, initial-scale=1">${H}<style>${W}</style></head><body><div class="container"><div class="row"><div class="col-xs-12">${d(`# ${t}`)}`),e(d("This report is not a complete accessibility audit.  This report only documents those accessibility features tested by the axe-core library, and should not be considered exhaustive of the possible accessibility issues a website may have.  Use this report as a tool in a complete and comprehensive process of reviewing this site for accessibility issues.  More information regarding the features tested by the axe-core library may be found at [axe-core.org](https://axe-core.org/)")),1!==this[z].random&&e(d(`This report represents only a random sample of ${Math.round(100*this[z].random)}% of all webpages on this domain.`))}.bind(this),this[Z]=M.bind(this),this[V]=L.bind(this),this[Y]=function(){const e=this[X];e('<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"><\/script><script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"><\/script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js" integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4" crossorigin="anonymous"><\/script>'),e("</body><script><\/script></html>"),i.closeSync(this[Q])}.bind(this)}open(){var e=this;return f(function*(){const{output:t}=e[z];i.writeFileSync(`${t}.html`,""),e[Q]=i.openSync(`${t}.html`,"w"),e[X]=function(t){return i.writeSync(e[Q],t)}})()}write(e){var t=this;return f(function*(){yield t[G](),yield t[Z](e),yield t[V](e)})()}close(){var e=this;return f(function*(){e[z].logger.debug("Ending HTML output"),e[Y]()})()}}function te(e,t){const r=new Set;return e[t].forEach(({viewPort:e,report:i})=>{JSON.parse(i).forEach(({description:e})=>{this[B][t]+=1,r.add(`* ${h(e)}\n`)})}),r.size>0?d([...r].reduce((e,t)=>e+t,"")):`No ${t} detected by axe-core`}function re(e){return e.reduce((e,{viewPort:t,url:r,report:i})=>{return e+JSON.parse(i).length},0)}function ie(e,{html:t,any:r,all:i,none:n}){return e+=`<li>${h(t)}`,r.forEach(({message:t})=>{e+=`<br />${h(t)}`}),i.forEach(({message:t})=>{e+=`<br />${h(t)}`}),n.forEach(({message:t})=>{e+=`<br />${h(t)}`}),e+="</li>"}function ne(e,t){const{viewPort:r,url:i,report:n}=e,s=JSON.parse(n);let o=`<div class="affected-nodes-box"><a href="#${i}-${r}-list" data-toggle="collapse" role="button" aria-expanded="false" aria-controls="${i}-${r}-list"><div class="affected-nodes-title-box"><h4><span>${h(i)} ${r.toUpperCase()}</span><span>${s.length} ${t}</span></h4></div><a><div class="affected-nodes-list-box collapse" id="${i}-${r}-list"><ol class="affected-nodes-list">`;return s.length>0?o+=`${s.reduce((e,{description:t,nodes:r,impact:i})=>(e+=`<li>${i?`${i.toUpperCase()}: `:""}${h(t)}<br />`,e+="<span>Affected Nodes: </span><ul>",e+=r.reduce(ie,""),e+="</ul></li>"),"")}</ol></div></div>`:""}let se=(oe=f(function*(e){var t=this;const r=this[ce],{logger:i}=this[ae];var n;yield r(`{"date": "${(new Date).toString()}","title":"aXe Accessibility Engine Report for ${this[ae].domain}","reports": {`),yield Promise.all(e.map((n=f(function*({url:e},i,n){const s=yield t[ae].db.read("violations_summary",{url:e}),o=yield t[ae].db.read("passes_summary",{url:e}),a={violations:s.reduce(he,{}),passes:o.reduce(he,{})};r(`"${e}": ${JSON.stringify(a)}`),i!==n.length-1&&r(",")}),function(e,t,r){return n.apply(this,arguments)}))),i.debug("Ending JSON output"),r("}}")}),function(e){return oe.apply(this,arguments)});var oe;const ae=Symbol("Options"),le=Symbol("Filename"),ce=Symbol("Append an html string to the report file"),ue=Symbol("Process data and write to JSON output");class de{constructor(e){this[ae]=e,this[ue]=se.bind(this)}open(){const{output:e}=this[ae];i.writeFileSync(`${e}.json`,""),this[le]=i.openSync(`${e}.json`,"w"),this[ce]=(e=>i.writeSync(this[le],e))}write(e){var t=this;return f(function*(){yield t[ue](e)})()}close(){i.closeSync(this[le])}}function he(e,t){return e[t.viewPort]=JSON.parse(t.report),e}let pe=(fe=f(function*(e){const{logger:t,db:r}=this[me];try{const{url:i,viewPort:{name:n,width:s,height:o}}=e,a=new c.Options;a.addArguments("headless","disable-gpu",`--window-size=${s},${o}`);const d=(new l.Builder).forBrowser("chrome").setChromeOptions(a).build(),h=yield new Promise(function(r,s){d.get(i).then(function(){t.debug("Test case: ",e),t.info(`Got ${i}`),t.info(`Testing ${i} ${n}`),u(d).analyze(function(e,o){o&&s(o),t.debug(`Results for ${i} ${n} received`),r(e),d.close()})})});yield r.create("axe_result",{url:i,violations:JSON.stringify(h.violations),passes:JSON.stringify(h.passes),viewPort:`${n}:${s}x${o}`})}catch(e){t.error("Error encountered in using Selenium Webdriver: "),t.error(e),process.exit(1)}}),function(e){return fe.apply(this,arguments)});var fe;const me=Symbol("Options"),ye=Symbol("Queue"),ge=Symbol("Take a random sample"),be=Symbol("Run axe-core tests on a page"),ve=Symbol("Create a list of views to test");let we=($e=f(function*(){const t=new class{constructor(e={}){this[C]=J,this[I]=function(){const e=n(process.argv.slice(2));var t;e.domain=e._.last(),delete e._,e.viewPorts&&(e.viewPorts=(t=e.viewPorts).split(",").map(e=>{const r=/(\w+):(\d+)x(\d+)/;try{const[,i,n,s]=r.exec(e);return{name:i,width:n,height:s}}catch(e){throw new Error(`Invalid viewports: ${t}`)}}).filter(e=>e),0===e.viewPorts.length&&delete e.viewPorts);let{verbose:r}=e;e.dryRun&&(r=e.verbose||"debug",e.check=0),e.quiet&&(r="quiet");const i=new s({level:r||"error"});return e.dryRun&&!e.quiet&&i.log(`Performing dry run with ${r.toUpperCase()} level logging`),Object.assign({},e,{logger:i,verbose:r})}.call(this),this[A]=function(){const{logger:e,configFile:t}=this[I],r=t||D;let n={};try{n=JSON.parse(i.readFileSync(r).toString())}catch(t){"ENOENT"===t.code&&t.path===r?e.error("No config file found"):t instanceof SyntaxError&&e.error(`Invalid JSON config file ${r}\n\nIgnoring JSON config file...`)}return n}.call(this),Object.assign(this,this[C],this[A],this[I],e),function(){const{logger:e,random:t}=this;t>0&&t<=1||(e.error(`Invalid random sampling rate specified: ${t}.  Defaulting to 100%`),this.random=1)}.call(this),this.logger.debug("Crawling with the following options: ",JSON.stringify(this,null,4))}reportVersion(){this.version&&console.log(`axe-crawler v${F}`)}setNumberToCheck(e){const{check:t}=this;var r;this.numToCheck=Math.min((r=t)<0||!Number.isInteger(r)?1/0:t,e.size)}configureDB(){var e=this;return f(function*(){const{random:t,viewPorts:r,numToCheck:i,useFileOver:n,logger:s}=e;t*i*r.length>n?(s.info(`Over ${n} page views to test, switching to SQLite file mode to store results`),e.db=new R({type:"file"})):(s.debug(`Fewer than ${n} page views, using in-memory SQLite to store results`),e.db=new R({type:"memory"})),yield e.db.initialize()})()}};t.reportVersion();const o=yield new class{constructor(e){this[g]=e,this[b]=new Set,this[v]=function(e,t){if(void 0===t)return new Set;if(200===t.status){const e=r.load(t.data)("a"),i=t.config.url;return new Set(Object.keys(e).map(function(e,t){const r=e.replace(new RegExp("^(https?://(\\w+\\.?)+)/(.*)$"),"$1");return i=>{if(t[i].attribs){const n=t[i].attribs.href;if(n)return n.replace(new RegExp(`^(?!https?://)(?!${e}/)(/?)(.*)`),`${r}/$2`).replace(new RegExp(`^${r}//`),"http://")}return null}}(i,e)).filter(e=>"string"==typeof e).filter(this[w]).map(e=>e.replace(/^https:\/\//,"http://")))}return new Set}.bind(this),this[w]=p(e),this[$]=m.bind(this),this[S]=function(e){const{domain:t}=this[g];return e.filter(e=>!(e instanceof Error)).map(e=>this[v](t,e)).reduce(x,new Set).difference(this[b])}.bind(this)}crawl(){var t=this;return f(function*(){const{domain:r,depth:i=5,logger:n}=t[g],s=`http://${r}`;if(void 0==r)return console.log("No domain provided.  Exiting..."),process.exit(0);if(!e.isURL(s))return n.error(new Error(`Invalid url: ${s}`)),process.exit(1);if(t[b].add(s),0===i)return t[b];try{n.debug(`Crawling ${s}`);let e=t[b];for(let r=0;r<i;r+=1){n.debug(`Crawling for links at DEPTH ${r+1}`);const i=yield t[$](e);if(0===(e=t[S](i)).size)break;n.debug(`${e.size} links found`);for(const r of e)t[b].add(r)}return t[b]}catch(e){return n.error("Error crawling for links: ",e),process.exit(1)}})()}}(t).crawl();t.setNumberToCheck(o);const{logger:a,viewPorts:l,random:c,domain:u}=t;a.debug("Queue to be tested: ",JSON.stringify(o,null,4)),a.info(`Found ${o.size} links within ${u}`,`Based on options, testing ${t.numToCheck} urls`),c>0&&c<1&&a.info(`Selecting random sample: ${c} of ${t.numToCheck} urls`),yield t.configureDB();let d="";l.forEach(function({name:e,width:t,height:r}){d+=`\t\t${e}: ${t}x${r}\n`}),a.debug(`Testing ${l.length} viewPorts: \n${d}`);try{Object.freeze(t);const e=new class{constructor(e){var t,r;this[me]=e,this[be]=pe.bind(this),this[ge]=(t=this[me],(e,r)=>t.random?Math.random()<t.random?(e.push(r),e):e:(e.push(r),e)),this[ve]=(r=this[me],(e,t)=>(r.viewPorts.forEach(r=>{e.push({url:t,viewPort:r})}),e))}queue(e){const{numToCheck:t}=this[me];this[ye]=[...e].reduce(this[ge],[]).slice(0,t).reduce(this[ve],[])}run(){var e=this;return f(function*(){yield Promise.all(e[ye].map(e[be]))})()}report(){var e=this;return f(function*(){const{logger:t,db:r}=e[me],i=yield r.read("tested_pages");t.info("Saving JSON report");const n=new de(e[me]);yield n.open(),yield n.write(i),yield n.close(),t.info("Saving HTML Report");const s=new ee(e[me]);yield s.open(),yield s.write(i),yield s.close()})()}}(t);yield e.queue(o),yield e.run(),yield e.report()}catch(e){a.error(e),process.exit(1)}process.exit(0)}),function(){return $e.apply(this,arguments)});var $e;!function(){const e=Function.bind.call(Function.call,Array.prototype.reduce),t=Function.bind.call(Function.call,Object.prototype.propertyIsEnumerable),r=Function.bind.call(Function.call,Array.prototype.concat),i=Reflect.ownKeys;Set.prototype.difference=function(e){const t=new Set(this);for(const r of e)t.delete(r);return t},Object.entries||(Object.entries=function(n){return e(i(n),(e,i)=>r(e,"string"==typeof i&&t(n,i)?[[i,n[i]]]:[]),[])}),Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]})}(),we()});
